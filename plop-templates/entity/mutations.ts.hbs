import { useMutation, useQueryClient, type UseMutationOptions } from '@tanstack/react-query'
import { apiClient } from '@/shared/api'
import type { Create{{pascalCase name}}Input, Update{{pascalCase name}}Input, {{pascalCase name}} } from '@/entities/{{camelCase name}}/types'
import { {{camelCase name}}Keys } from './keys'

/**
 * Create {{camelCase name}} mutation function
 */
async function create{{pascalCase name}}(data: Create{{pascalCase name}}Input): Promise<{{pascalCase name}}> {
  const response = await apiClient.post<{{pascalCase name}}>('/{{camelCase name}}s', data)
  if (!response.data) {
    throw new Error('No {{camelCase name}} data returned')
  }
  return response.data
}

/**
 * Hook to create {{camelCase name}}
 *
 * @example
 * const create{{pascalCase name}} = useCreate{{pascalCase name}}()
 * create{{pascalCase name}}.mutate(data)
 */
export function useCreate{{pascalCase name}}(
  options?: Omit<UseMutationOptions<{{pascalCase name}}, Error, Create{{pascalCase name}}Input>, 'mutationFn'>,
) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: create{{pascalCase name}},
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: {{camelCase name}}Keys.lists() })
    },
    ...options,
  })
}

/**
 * Update {{camelCase name}} mutation function
 */
async function update{{pascalCase name}}(id: string, data: Update{{pascalCase name}}Input): Promise<{{pascalCase name}}> {
  const response = await apiClient.put<{{pascalCase name}}>(`/{{camelCase name}}s/${id}`, data)
  if (!response.data) {
    throw new Error('No {{camelCase name}} data returned')
  }
  return response.data
}

/**
 * Hook to update {{camelCase name}} with optimistic updates
 *
 * @example
 * const update{{pascalCase name}} = useUpdate{{pascalCase name}}()
 * update{{pascalCase name}}.mutate({ id: '123', data: { ... } })
 */
export function useUpdate{{pascalCase name}}(
  options?: Omit<
    UseMutationOptions<{{pascalCase name}}, Error, { id: string; data: Update{{pascalCase name}}Input }>,
    'mutationFn'
  >,
) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: ({ id, data }) => update{{pascalCase name}}(id, data),
    onMutate: async ({ id, data }) => {
      await queryClient.cancelQueries({ queryKey: {{camelCase name}}Keys.detail(id) })
      const previous = queryClient.getQueryData<{{pascalCase name}}>({{camelCase name}}Keys.detail(id))

      if (previous) {
        queryClient.setQueryData<{{pascalCase name}}>({{camelCase name}}Keys.detail(id), {
          ...previous,
          ...data,
        })
      }

      return { previous }
    },
    onError: (_error, { id }, context) => {
      if (context?.previous) {
        queryClient.setQueryData({{camelCase name}}Keys.detail(id), context.previous)
      }
    },
    onSettled: (_data, _error, { id }) => {
      queryClient.invalidateQueries({ queryKey: {{camelCase name}}Keys.detail(id) })
      queryClient.invalidateQueries({ queryKey: {{camelCase name}}Keys.lists() })
    },
    ...options,
  })
}

/**
 * Delete {{camelCase name}} mutation function
 */
async function delete{{pascalCase name}}(id: string): Promise<void> {
  await apiClient.delete(`/{{camelCase name}}s/${id}`)
}

/**
 * Hook to delete {{camelCase name}}
 *
 * @example
 * const delete{{pascalCase name}} = useDelete{{pascalCase name}}()
 * delete{{pascalCase name}}.mutate('{{camelCase name}}-id-123')
 */
export function useDelete{{pascalCase name}}(
  options?: Omit<UseMutationOptions<void, Error, string>, 'mutationFn'>,
) {
  const queryClient = useQueryClient()

  return useMutation({
    mutationFn: delete{{pascalCase name}},
    onSuccess: (_data, id) => {
      queryClient.removeQueries({ queryKey: {{camelCase name}}Keys.detail(id) })
      queryClient.invalidateQueries({ queryKey: {{camelCase name}}Keys.lists() })
    },
    ...options,
  })
}
